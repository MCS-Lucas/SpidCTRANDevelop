@page "/usuarios"
@using Microsoft.EntityFrameworkCore
@using Spid.Data
@inject AppDbContext Db
@inject UserSession UserSession
@inject NavigationManager Nav

<PageTitle>Gerenciar Usu√°rios ‚Äî SPID</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>üë• Gerenciar Usu√°rios</h3>
    <a href="/usuarios/novo" class="btn btn-primary">
        + Novo Usu√°rio
    </a>
</div>

@if (!isAdmin)
{
    <div class="alert alert-warning">Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.</div>
}
else if (usuarios is null)
{
    <p class="text-muted">Carregando...</p>
}
else if (usuarios.Count == 0)
{
    <div class="alert alert-info">Nenhum usu√°rio cadastrado.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th class="text-center">Nome</th>
                    <th class="text-center">Ponto</th>
                    <th class="text-center">E-mail</th>
                    <th class="text-center">Perfil</th>
                    <th class="text-center">Setor</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var u in usuarios)
                {
                    <tr class="@(u.Ativo ? "" : "table-secondary")">
                        <td class="text-center">@u.Nome</td>
                        <td class="text-center"><code>@u.Ponto</code></td>
                        <td class="text-center">@u.Email</td>
                        <td class="text-center">
                            <span class="badge @(u.Perfil == "Admin" ? "bg-danger" : "bg-primary")">
                                @u.Perfil
                            </span>
                        </td>
                        <td class="text-center">@(u.Setor?.Nome ?? "‚Äî")</td>
                        <td class="text-center">
                            <span class="badge @(u.Ativo ? "bg-success" : "bg-secondary")">
                                @(u.Ativo ? "Ativo" : "Inativo")
                            </span>
                        </td>
                        <td class="text-center">
                            <a href="/usuarios/editar/@u.Id" class="btn btn-sm btn-outline-primary me-1">
                                ‚úèÔ∏è Editar
                            </a>
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmarExclusao(u)">
                                üóëÔ∏è Excluir
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@if (usuarioParaExcluir is not null)
{
    <div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclus√£o</h5>
                    <button type="button" class="btn-close" @onclick="CancelarExclusao"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir o usu√°rio <strong>@usuarioParaExcluir.Nome</strong> (Ponto:
                        @usuarioParaExcluir.Ponto)?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CancelarExclusao">Cancelar</button>
                        <button class="btn btn-danger" @onclick="ExecutarExclusao">Excluir</button>
                    </div>
                </div>
            </div>
        </div>
    }

@code {
    private List<Usuario>? usuarios;
    private bool isAdmin;
    private Usuario? usuarioParaExcluir;

    protected override async Task OnInitializedAsync()
    {
        if (!UserSession.IsAuthenticated)
        {
            Nav.NavigateTo("/login");
            return;
        }

        isAdmin = UserSession.UsuarioLogado!.Perfil == "Admin";
        if (!isAdmin) return;

        await CarregarUsuarios();
    }

    private async Task CarregarUsuarios()
    {
        usuarios = await Db.Usuarios
            .Include(u => u.Setor)
            .OrderBy(u => u.Nome)
            .ToListAsync();
    }

    private void ConfirmarExclusao(Usuario u)
    {
        usuarioParaExcluir = u;
    }

    private void CancelarExclusao()
    {
        usuarioParaExcluir = null;
    }

    private async Task ExecutarExclusao()
    {
        if (usuarioParaExcluir is null) return;

        // N√£o permitir excluir a si mesmo
        if (usuarioParaExcluir.Id == UserSession.UsuarioLogado!.Id)
        {
            usuarioParaExcluir = null;
            return;
        }

        Db.Usuarios.Remove(usuarioParaExcluir);
        await Db.SaveChangesAsync();
        usuarioParaExcluir = null;
        await CarregarUsuarios();
    }
}
