@page "/analisar-viagens"
@using Microsoft.EntityFrameworkCore
@using Spid.Data
@inject AppDbContext Db
@inject UserSession UserSession
@inject NavigationManager Nav

<PageTitle>Analisar Viagens ‚Äî SPID</PageTitle>

<h3 class="mb-4">üîç Analisar Viagens</h3>

@if (!temPermissao)
{
    <div class="alert alert-warning">Voc√™ n√£o tem permiss√£o para acessar esta funcionalidade.</div>
}
else if (viagens is null)
{
    <p class="text-muted">Carregando...</p>
}
else
{
    <!-- Filtros -->
    <div class="card shadow-sm mb-4">
        <div class="card-body d-flex gap-3 align-items-end flex-wrap">
            <div>
                <label class="form-label small mb-1">M√™s/Ano</label>
                <input type="month" class="form-control form-control-sm" value="@filtroMes.ToString("yyyy-MM")"
                       @onchange="OnMesAlterado" />
            </div>
            <div>
                <label class="form-label small mb-1">Status</label>
                <select class="form-select form-select-sm" @bind="filtroStatus" @bind:after="Filtrar">
                    <option value="">Todos</option>
                    <option value="Pendente">Pendente</option>
                    <option value="OK">OK</option>
                    <option value="Contestada">Contestada</option>
                </select>
            </div>
            <div>
                <label class="form-label small mb-1">Colaborador</label>
                <input type="text" class="form-control form-control-sm" placeholder="Buscar..." @bind="filtroColaborador"
                       @bind:after="Filtrar" />
            </div>
            <div>
                <span class="badge bg-secondary align-self-center">
                    @viagensFiltradas.Count viagem(ns)
                </span>
            </div>
        </div>
    </div>

    <!-- Resumo -->
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card text-center border-warning">
                <div class="card-body py-2">
                    <div class="fs-3 fw-bold text-warning">@viagens.Count(v => v.StatusConferenciaGestor == "Pendente")
                    </div>
                    <small class="text-muted">Pendentes</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center border-success">
                <div class="card-body py-2">
                    <div class="fs-3 fw-bold text-success">@viagens.Count(v => v.StatusConferenciaGestor == "OK")</div>
                    <small class="text-muted">Aprovadas</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center border-danger">
                <div class="card-body py-2">
                    <div class="fs-3 fw-bold text-danger">@viagens.Count(v => v.StatusConferenciaGestor == "Contestada")
                    </div>
                    <small class="text-muted">Contestadas</small>
                </div>
            </div>
        </div>
    </div>

    @if (viagensFiltradas.Count == 0)
    {
        <div class="alert alert-info">Nenhuma viagem encontrada com os filtros selecionados.</div>
    }
    <!-- Pagina√ß√£o: seletor de itens por p√°gina -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center gap-2">
            <small class="text-muted">Exibir</small>
            <select class="form-select form-select-sm" style="width: auto;" @bind="itensPorPagina"
                    @bind:after="OnPageSizeChanged">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="30">30</option>
                <option value="50">50</option>
            </select>
            <small class="text-muted">viagens por p√°gina</small>
        </div>
        <small class="text-muted">
            P√°gina @paginaAtual de @totalPaginas &mdash; @viagensFiltradas.Count viagem(ns)
        </small>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th class="text-center" role="button" @onclick="AlternarOrdemData" style="cursor:pointer;">
                        Data @(ordenarDataAsc ? "‚ñ≤" : "‚ñº")
                    </th>
                    <th class="text-center">Colaborador</th>
                    <th class="text-center">Origem</th>
                    <th class="text-center">Destino</th>
                    <th class="text-center">Parceiro</th>
                    <th class="text-center">Valor Final</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var v in viagensPaginadas)
                {
                    <tr>
                        <td class="text-center">@v.DataViagem.ToString("dd/MM/yyyy")</td>
                        <td class="text-center">@v.Colaborador.Nome</td>
                        <td class="text-center">@v.Origem</td>
                        <td class="text-center">@v.Destino</td>
                        <td class="text-center">@v.Parceiro.Nome</td>
                        <td class="text-center">R$ @v.ValorFinal.ToString("N2")</td>
                        <td class="text-center">
                            @switch (v.StatusConferenciaGestor)
                            {
                                case "Pendente":
                                    <span class="badge bg-warning text-dark">‚è≥ Pendente</span>
                                    break;
                                case "OK":
                                    <span class="badge bg-success">‚úÖ OK</span>
                                    break;
                                case "Contestada":
                                    <span class="badge bg-danger">‚ùå Contestada</span>
                                    break;
                            }
                        </td>
                        <td class="text-center">
                            @if (v.StatusConferenciaGestor == "Pendente")
                            {
                                <button class="btn btn-sm btn-success me-1" @onclick="() => Aprovar(v)">
                                    ‚úÖ OK
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="() => AbrirContestacao(v)">
                                    ‚ùå Contestar
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => Reverter(v)">
                                    ‚Ü©Ô∏è Reverter
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Navega√ß√£o de p√°ginas -->
    @if (totalPaginas > 1)
    {
        <nav>
            <ul class="pagination pagination-sm justify-content-center">
                <li class="page-item @(paginaAtual == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => IrParaPagina(paginaAtual - 1)">&laquo;</button>
                </li>
                @for (int i = 1; i <= totalPaginas; i++)
                {
                    var pg = i;
                    <li class="page-item @(pg == paginaAtual ? "active" : "")">
                        <button class="page-link" @onclick="() => IrParaPagina(pg)">@pg</button>
                    </li>
                }
                <li class="page-item @(paginaAtual == totalPaginas ? "disabled" : "")">
                    <button class="page-link" @onclick="() => IrParaPagina(paginaAtual + 1)">&raquo;</button>
                </li>
            </ul>
        </nav>
    }

    <!-- Confirma√ß√£o Mensal -->
    @if (viagens is not null && viagens.Count > 0)
    {
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                @if (jaConfirmou && confirmadoPorNome is not null)
                {
                    <div class="alert alert-success mb-0">
                        ‚úÖ Verifica√ß√£o de <strong>@filtroMes.ToString("MM/yyyy")</strong> confirmada por
                        <strong>@confirmadoPorNome</strong> em @confirmadoEm?.ToString("dd/MM/yyyy HH:mm")
                    </div>
                }
                else if (jaConfirmou)
                {
                    <div class="alert alert-success mb-0">
                        ‚úÖ Verifica√ß√£o do m√™s <strong>@filtroMes.ToString("MM/yyyy")</strong> j√° foi confirmada.
                    </div>
                }
                else if (todasVerificadas)
                {
                    <div class="alert alert-info mb-2">
                        Todas as viagens foram analisadas! Confirme a verifica√ß√£o do m√™s.
                    </div>
                    <button class="btn btn-success" @onclick="ConfirmarMes" disabled="@confirmando">
                        @if (confirmando)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        ‚úÖ Confirmar Verifica√ß√£o de @filtroMes.ToString("MM/yyyy")
                    </button>
                }
                else
                {
                    <div class="alert alert-warning mb-0">
                        ‚è≥ Ainda h√° <strong>@viagens.Count(v => v.StatusConferenciaGestor == "Pendente")</strong> viagem(ns)
                        pendente(s). Analise todas para poder confirmar o m√™s.
                    </div>
                }
            </div>
        </div>
    }
}

@* Modal de contesta√ß√£o *@
@if (viagemContestar is not null)
{
    <div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Contestar Viagem</h5>
                    <button type="button" class="btn-close" @onclick="FecharContestacao"></button>
                </div>
                <div class="modal-body">
                    <p>
                        Viagem de <strong>@viagemContestar.Colaborador.Nome</strong>
                        em @viagemContestar.DataViagem.ToString("dd/MM/yyyy")
                        ‚Äî R$ @viagemContestar.ValorFinal.ToString("N2")
                    </p>
                    <div class="mb-3">
                        <label class="form-label">Motivo da contesta√ß√£o</label>
                        <textarea class="form-control" rows="3" @bind="motivoContestacao"
                                  placeholder="Descreva o motivo..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="FecharContestacao">Cancelar</button>
                    <button class="btn btn-danger" @onclick="ConfirmarContestacao"
                            disabled="@string.IsNullOrWhiteSpace(motivoContestacao)">
                        Confirmar Contesta√ß√£o
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool temPermissao;
    private List<Viagem>? viagens;
    private List<Viagem> viagensFiltradas = new();

    private DateTime filtroMes = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
    private string filtroStatus = "";
    private string filtroColaborador = "";

    private Viagem? viagemContestar;
    private string motivoContestacao = "";

    private bool jaConfirmou;
    private bool todasVerificadas;
    private bool confirmando;
    private string? confirmadoPorNome;
    private DateTime? confirmadoEm;

    // Ordena√ß√£o e pagina√ß√£o
    private bool ordenarDataAsc;
    private int itensPorPagina = 10;
    private int paginaAtual = 1;
    private int totalPaginas => (int)Math.Ceiling((double)viagensFiltradas.Count / itensPorPagina);
    private List<Viagem> viagensPaginadas => viagensFiltradas
        .Skip((paginaAtual - 1) * itensPorPagina)
        .Take(itensPorPagina)
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        if (!UserSession.IsAuthenticated)
        {
            Nav.NavigateTo("/login");
            return;
        }

        var perfil = UserSession.UsuarioLogado!.Perfil;
        temPermissao = await Db.PerfisRecurso
            .AnyAsync(pr => pr.Perfil == perfil && pr.Recurso.Chave == "AnalisarViagens");

        if (!temPermissao) return;

        await CarregarViagens();
    }

    private async Task CarregarViagens()
    {
        var setorId = UserSession.UsuarioLogado!.SetorId;

        // Filtro por m√™s/ano
        var mesInicio = new DateOnly(filtroMes.Year, filtroMes.Month, 1);
        var mesFim = mesInicio.AddMonths(1);

        var query = Db.Viagens
            .Include(v => v.Colaborador)
            .Include(v => v.Parceiro)
            .Include(v => v.Setor)
            .Where(v => v.DataViagem >= mesInicio && v.DataViagem < mesFim);

        // Se o gestor tem setor, filtra; admin v√™ tudo
        if (setorId.HasValue)
        {
            query = query.Where(v => v.SetorId == setorId.Value);
        }

        viagens = await query
            .OrderByDescending(v => v.DataViagem)
            .ThenBy(v => v.StatusConferenciaGestor)
            .ToListAsync();

        Filtrar();
        await VerificarConfirmacao();
    }

    private async Task VerificarConfirmacao()
    {
        var setorId = UserSession.UsuarioLogado!.SetorId;
        if (!setorId.HasValue || viagens is null) return;

        var conferencia = await Db.ConferenciasMensais
            .Include(c => c.Usuario)
            .FirstOrDefaultAsync(c => c.SetorId == setorId.Value && c.Ano == filtroMes.Year && c.Mes == filtroMes.Month);

        jaConfirmou = conferencia is not null;
        confirmadoPorNome = conferencia?.Usuario.Nome;
        confirmadoEm = conferencia?.DataConfirmacao;

        todasVerificadas = viagens.Count > 0 && viagens.All(v => v.StatusConferenciaGestor != "Pendente");
    }

    private void Filtrar()
    {
        if (viagens is null) return;

        var resultado = viagens
            .Where(v => string.IsNullOrEmpty(filtroStatus) || v.StatusConferenciaGestor == filtroStatus)
            .Where(v => string.IsNullOrEmpty(filtroColaborador) ||
                        v.Colaborador.Nome.Contains(filtroColaborador, StringComparison.OrdinalIgnoreCase));

        viagensFiltradas = ordenarDataAsc
            ? resultado.OrderBy(v => v.DataViagem).ToList()
            : resultado.OrderByDescending(v => v.DataViagem).ToList();

        // Resetar p√°gina se necess√°rio
        if (paginaAtual > totalPaginas && totalPaginas > 0) paginaAtual = totalPaginas;
        if (paginaAtual < 1) paginaAtual = 1;
    }

    private void AlternarOrdemData()
    {
        ordenarDataAsc = !ordenarDataAsc;
        Filtrar();
    }

    private void IrParaPagina(int pagina)
    {
        if (pagina >= 1 && pagina <= totalPaginas)
            paginaAtual = pagina;
    }

    private void OnPageSizeChanged()
    {
        paginaAtual = 1;
        Filtrar();
    }

    private async Task OnMesAlterado(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString() + "-01", out var data))
        {
            filtroMes = data;
            await CarregarViagens();
        }
    }

    private async Task Aprovar(Viagem v)
    {
        v.StatusConferenciaGestor = "OK";
        v.DataConferencia = DateTime.Now;
        v.MotivoContestacao = null;
        await Db.SaveChangesAsync();
        await InvalidarConfirmacao();
        Filtrar();
        await VerificarConfirmacao();
    }

    private void AbrirContestacao(Viagem v)
    {
        viagemContestar = v;
        motivoContestacao = "";
    }

    private void FecharContestacao()
    {
        viagemContestar = null;
        motivoContestacao = "";
    }

    private async Task ConfirmarContestacao()
    {
        if (viagemContestar is null || string.IsNullOrWhiteSpace(motivoContestacao)) return;

        viagemContestar.StatusConferenciaGestor = "Contestada";
        viagemContestar.DataConferencia = DateTime.Now;
        viagemContestar.MotivoContestacao = motivoContestacao;
        await Db.SaveChangesAsync();

        FecharContestacao();
        await InvalidarConfirmacao();
        Filtrar();
        await VerificarConfirmacao();
    }

    private async Task Reverter(Viagem v)
    {
        v.StatusConferenciaGestor = "Pendente";
        v.DataConferencia = null;
        v.MotivoContestacao = null;
        await Db.SaveChangesAsync();
        await InvalidarConfirmacao();
        Filtrar();
        await VerificarConfirmacao();
    }

    /// Remove a confirma√ß√£o existente deste setor/m√™s para for√ßar reconfirma√ß√£o
    private async Task InvalidarConfirmacao()
    {
        var setorId = UserSession.UsuarioLogado!.SetorId;
        if (!setorId.HasValue) return;

        var conf = await Db.ConferenciasMensais
            .FirstOrDefaultAsync(c => c.SetorId == setorId.Value && c.Ano == filtroMes.Year && c.Mes == filtroMes.Month);

        if (conf is not null)
        {
            Db.ConferenciasMensais.Remove(conf);
            await Db.SaveChangesAsync();
        }
    }

    private async Task ConfirmarMes()
    {
        var setorId = UserSession.UsuarioLogado!.SetorId;
        if (!setorId.HasValue) return;

        confirmando = true;
        try
        {
            var conferencia = new ConferenciaMensal
            {
                SetorId = setorId.Value,
                Ano = filtroMes.Year,
                Mes = filtroMes.Month,
                UsuarioId = UserSession.UsuarioLogado!.Id,
                DataConfirmacao = DateTime.Now
            };
            Db.ConferenciasMensais.Add(conferencia);
            await Db.SaveChangesAsync();
            jaConfirmou = true;
        }
        finally
        {
            confirmando = false;
        }
    }
}
